openapi: 3.0.3
info:
  title: API Specification for Explento WebApp
  version: 1.0.0

servers:
  - url: http://localhost:3000/api/v1

paths:

  ##########################
  # AUTH
  ##########################

  /auth/login:
    post:
      summary: Login utente
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            example:
              username: "mario.rossi"
              password: "Password123!"
      responses:
        "200":
          description: Login effettuato, restituisce JWT
          content:
            application/json:
              example:
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Im1hcmlvLnJvc3NpIiwiaWF0IjoxNjg3NjEyMzQ1fQ.DlA8fNn8k_YxQFw1Uo5vNshl5-8Y7kF_8c3zQJfhZyI"
        "400":
          description: Credenziali non valide
          content:
            application/json:
              example:
                error: "Username o password non validi"

  /auth/register:
    post:
      summary: Registrazione utente
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            example:
              username: "luca.bianchi"
              email: "luca.bianchi@example.com"
              name: "Luca"
              surname: "Bianchi"
              password: "StrongPass!2026"
      responses:
        "201":
          description: Utente registrato
          content:
            application/json:
              example:
                id: "65f1a2c9e4b0a12f34abcd12"
                username: "luca.bianchi"
                email: "luca.bianchi@example.com"
                name: "Luca"
                surname: "Bianchi"
                profileImage: "https://example.com/avatar_luca.jpg"
                preferences:
                  alsoPaid: true
                  categories: ["montagna","cultura"]
                expert: false
                exp: 0
                discoveredPlaces: []
                suggestedPlaces: []
                missionsProgresses: []
        "400":
          description: Dati non validi
          content:
            application/json:
              example:
                error: "Email già in uso o campi mancanti"

  ##########################
  # ME
  ##########################

  /me:
    get:
      summary: Ottieni informazioni sull'utente autenticato
      tags: [Me]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Informazioni utente
          content:
            application/json:
              example:
                id: "65f1a2c9e4b0a12f34abcd12"
                username: "luca.bianchi"
                email: "luca.bianchi@example.com"
                name: "Luca"
                surname: "Bianchi"
                profileImage: "https://example.com/avatar_luca.jpg"
                preferences:
                  alsoPaid: true
                  categories: ["montagna","cultura"]
                expert: false
                exp: 10
                discoveredPlaces:
                  - placeId: "65f1a2c9e4b0a12f34abcd99"
                    date: "2025-02-12T10:00:00.000Z"
                suggestedPlaces:
                  - placeId: "65f1a2c9e4b0a12f34abcd88"
                    visited: false
                    date: null
                missionsProgresses: []
        "401":
          description: Non autorizzato
          content:
            application/json:
              example:
                error: "Token mancante o scaduto"

  /me/visit/{id}:
    post:
      summary: Registra la visita di un luogo tramite coordinate GPS
      tags: [Me]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "65f1a2c9e4b0a12f34abcd99"
      requestBody:
        required: true
        content:
          application/json:
            example:
              lat: 45.4642
              lon: 9.1900
      responses:
        "200":
          description: Visita registrata
          content:
            application/json:
              example:
                success: true
        "400":
          description: Errore di validazione
          content:
            application/json:
              example:
                error: "Coordinate non valide"
        "401":
          description: Non autorizzato
          content:
            application/json:
              example:
                error: "Utente non autenticato"

  /me/preferences:
    post:
      summary: Aggiorna le preferenze dell'utente
      tags: [Me]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            example:
              alsoPaid: false
              categories: ["borgo","rilassante","per famiglie"]
      responses:
        "200":
          description: Preferenze aggiornate
          content:
            application/json:
              example:
                message: "Preferenze aggiornate con successo"
        "400":
          description: Dati mancanti o non validi
          content:
            application/json:
              example:
                error: "Formato JSON non valido o categorie mancanti"

  ##########################
  # USERS
  ##########################

  /users:
    get:
      summary: Ottieni lista utenti
      tags: [Users]
      parameters:
        - name: expert
          in: query
          schema:
            type: boolean
          example: true
      responses:
        "200":
          description: Lista utenti in formato pubblico
          content:
            application/json:
              example:
                - self: "/users/luca.bianchi"
                  username: "luca.bianchi"
                  exp: 10
                  profileImage: "https://example.com/avatar_luca.jpg"
                - self: "/users/mario.rossi"
                  username: "mario.rossi"
                  exp: 30
                  profileImage: "https://example.com/avatar_mario.jpg"
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

  /users/{username}:
    get:
      summary: Ottieni utente tramite username
      tags: [Users]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          example: "luca.bianchi"
      responses:
        "200":
          description: Utente trovato in formato pubblico
          content:
            application/json:
              example:
                self: "/users/luca.bianchi"
                username: "luca.bianchi"
                exp: 10
                profileImage: "https://example.com/avatar_luca.jpg"
        "404":
          description: Utente non trovato
          content:
            application/json:
              example:
                error: "Utente non trovato"

  ##########################
  # OPERATOR
  ##########################

  /operator/login:
    post:
      summary: Login operatore
      tags: [Operator]
      requestBody:
        required: true
        content:
          application/json:
            example:
              email: "operator@example.com"
              password: "OperatorPass!2026"
      responses:
        "200":
          description: Login effettuato, restituisce JWT
          content:
            application/json:
              example:
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiT3BlcmF0b3IiLCJpZCI6IjEyMzQ1NiIsImlhdCI6MTY4NzYxMjM0NX0.XYxFw1Uo5vNshl5-8Y7kF_8c3zQJfhZyI"
        "400":
          description: Credenziali non valide
          content:
            application/json:
              example:
                error: "Email o password non valide"

  /operator/me:
    get:
      summary: Ottieni informazioni operatore autenticato
      tags: [Operator]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Operatore trovato
          content:
            application/json:
              example:
                id: "123456"
                email: "operator@example.com"
                role: "admin"
                name: "Giulia"
                surname: "Verdi"
        "401":
          description: Non autorizzato
          content:
            application/json:
              example:
                error: "Token mancante o scaduto"

  /operator/place_edit_requests:
    get:
      summary: Ottieni richieste di modifica luoghi
      tags: [Operator]
      security:
        - bearerAuth: []
      parameters:
        - name: placeId
          in: query
          schema:
            type: string
          example: "65f1a2c9e4b0a12f34abcd99"
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, approved, rejected]
          example: "pending"
        - name: isNewPlace
          in: query
          schema:
            type: boolean
          example: true
      responses:
        "200":
          description: Lista richieste
          content:
            application/json:
              example:
                - id: "req123"
                  placeId: "65f1a2c9e4b0a12f34abcd99"
                  userId: "65f1a2c9e4b0a12f34abcd12"
                  proposedChanges:
                    name: "Nuovo Parco"
                    description: "Parco giochi aggiornato"
                  status: "pending"
                  operatorId: null
                  operatorComment: null
                  isNewPlace: true
                  createdAt: "2025-02-12T10:00:00.000Z"
                  updatedAt: "2025-02-12T10:00:00.000Z"
        "400":
          description: Parametri non validi
          content:
            application/json:
              example:
                error: "Parametro status non valido"

  /operator/place_edit_requests/{id}:
    get:
      summary: Ottieni richiesta di modifica specifica
      tags: [Operator]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "req123"
      responses:
        "200":
          description: Richiesta trovata
          content:
            application/json:
              example:
                id: "req123"
                placeId: "65f1a2c9e4b0a12f34abcd99"
                userId: "65f1a2c9e4b0a12f34abcd12"
                proposedChanges:
                  name: "Nuovo Parco"
                  description: "Parco giochi aggiornato"
                status: "pending"
                operatorId: null
                operatorComment: null
                isNewPlace: true
                createdAt: "2025-02-12T10:00:00.000Z"
                updatedAt: "2025-02-12T10:00:00.000Z"
        "404":
          description: Richiesta non trovata
          content:
            application/json:
              example:
                error: "Richiesta non trovata"

    patch:
      summary: Aggiorna stato richiesta
      tags: [Operator]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "req123"
      requestBody:
        required: true
        content:
          application/json:
            example:
              status: "approved"
              operatorComment: "Controllato e approvato"
      responses:
        "200":
          description: Stato aggiornato
          content:
            application/json:
              example:
                message: "Richiesta aggiornata"
                status: "approved"
        "400":
          description: Errore richiesta non valida
          content:
            application/json:
              example:
                error: "Stato non valido o richiesta già processata"
        "404":
          description: Richiesta non trovata
          content:
            application/json:
              example:
                error: "Richiesta non trovata"

  ##########################
  # PLACES
  ##########################

  /places:
    get:
      summary: Lista tutti i luoghi
      tags: [Places]
      security:
        - bearerAuth: []
      parameters:
        - name: lat
          in: query
          schema: { type: number }
          example: 45.4642
        - name: lon
          in: query
          schema: { type: number }
          example: 9.1900
        - name: radius
          in: query
          schema: { type: number }
          example: 5
      responses:
        "200":
          description: Lista luoghi filtrata
          content:
            application/json:
              example:
                - id: "65f1a2c9e4b0a12f34abcd99"
                  name: "Parco Sempione"
                  description: "Grande parco pubblico nel centro di Milano"
                  categories: ["cultura","rilassante"]
                  location:
                    lat: 45.4700
                    lon: 9.1800
                  images: ["https://example.com/parco1.jpg"]
                  isFree: true
                - id: "65f1a2c9e4b0a12f34abcd98"
                  name: "Museo della Scienza"
                  description: "Esplora scienza e tecnologia"
                  categories: ["scienza","indoor"]
                  location:
                    lat: 45.4660
                    lon: 9.1930
                  images: ["https://example.com/museo1.jpg"]
                  isFree: false
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

  /places/request:
    post:
      summary: Richiesta nuovo luogo
      tags: [Places]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            example:
              name: "Biblioteca Centrale"
              description: "Nuova biblioteca aperta in città"
              categories: ["cultura","indoor"]
              location:
                lat: 45.4630
                lon: 9.1910
              images: ["https://example.com/biblioteca.jpg"]
              isFree: true
      responses:
        "201":
          description: Richiesta creata
          content:
            application/json:
              example:
                message: "Richiesta creata con successo"
                request:
                  id: "req456"
                  placeId: "65f1a2c9e4b0a12f34abcd97"
                  userId: "65f1a2c9e4b0a12f34abcd12"
                  proposedChanges:
                    name: "Biblioteca Centrale"
                    description: "Nuova biblioteca aperta in città"
                  status: "pending"
                  operatorId: null
                  operatorComment: null
                  isNewPlace: true
                  createdAt: "2025-02-13T10:00:00.000Z"
                  updatedAt: "2025-02-13T10:00:00.000Z"
        "400":
          description: Dati non validi
          content:
            application/json:
              example:
                error: "Campo 'name' mancante"
        "401":
          description: Utente non autenticato o non esperto
          content:
            application/json:
              example:
                error: "Autenticazione richiesta o utente non esperto"

  /places/{id}:
    put:
      summary: Richiesta modifica luogo esistente
      tags: [Places]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
          example: "65f1a2c9e4b0a12f34abcd99"
      requestBody:
        required: true
        content:
          application/json:
            example:
              name: "Parco Sempione Aggiornato"
              description: "Parco con nuove aree giochi"
              categories: ["cultura","rilassante"]
              location:
                lat: 45.4700
                lon: 9.1800
              images: ["https://example.com/parco_agg.jpg"]
              isFree: true
      responses:
        "201":
          description: Richiesta modifica inviata
          content:
            application/json:
              example:
                message: "Richiesta modifica inviata"
                request:
                  id: "req789"
                  placeId: "65f1a2c9e4b0a12f34abcd99"
                  userId: "65f1a2c9e4b0a12f34abcd12"
                  proposedChanges:
                    name: "Parco Sempione Aggiornato"
                    description: "Parco con nuove aree giochi"
                  status: "pending"
                  operatorId: null
                  operatorComment: null
                  isNewPlace: false
                  createdAt: "2025-02-13T12:00:00.000Z"
                  updatedAt: "2025-02-13T12:00:00.000Z"
        "400":
          description: Dati non validi
          content:
            application/json:
              example:
                error: "Coordinate non valide o nome mancante"
        "401":
          description: Utente non autenticato
          content:
            application/json:
              example:
                error: "Autenticazione richiesta"

  ##########################
  # HEATMAP
  ##########################

  /heatmap/missions:
    get:
      summary: Heatmap delle missioni completate per luogo
      tags: [Heatmap]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista luoghi con conteggio missioni completate
          content:
            application/json:
              example:
                - placeId: "65f1a2c9e4b0a12f34abcd99"
                  name: "Parco Sempione"
                  completedMissions: 5
                  location:
                    lat: 45.4700
                    lon: 9.1800
                - placeId: "65f1a2c9e4b0a12f34abcd98"
                  name: "Museo della Scienza"
                  completedMissions: 2
                  location:
                    lat: 45.4660
                    lon: 9.1930
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

  ##########################
  # MISSIONS
  ##########################

  /missions:
    get:
      summary: Ottieni tutte le missioni
      tags: [Missions]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista completa missioni
          content:
            application/json:
              example:
                - id: "m001"
                  name: "Esplora Parco Sempione"
                  description: "Visita tutte le aree del parco"
                  minLevel: 1
                  rewardExp: 50
                  categories: ["montagna","rilassante"]
                  requiredPlaces:
                    - placeId: "65f1a2c9e4b0a12f34abcd99"
                  requiredCount: 1
                - id: "m002"
                  name: "Scopri Museo della Scienza"
                  description: "Completa il percorso educativo"
                  minLevel: 2
                  rewardExp: 100
                  categories: ["scienza","indoor"]
                  requiredPlaces:
                    - placeId: "65f1a2c9e4b0a12f34abcd98"
                  requiredCount: 1
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

    post:
      summary: Crea una nuova missione
      tags: [Missions]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            example:
              name: "Missione Parco"
              description: "Esplora il parco e segnala punti di interesse"
              minLevel: 1
              rewardExp: 50
              categories: ["montagna","rilassante"]
              requiredPlaces:
                - placeId: "65f1a2c9e4b0a12f34abcd99"
              requiredCount: 1
      responses:
        "201":
          description: Missione creata
          content:
            application/json:
              example:
                success: true
                mission:
                  id: "m003"
                  name: "Missione Parco"
                  description: "Esplora il parco e segnala punti di interesse"
                  minLevel: 1
                  rewardExp: 50
                  categories: ["montagna","rilassante"]
                  requiredPlaces:
                    - placeId: "65f1a2c9e4b0a12f34abcd99"
                  requiredCount: 1
        "400":
          description: Campi obbligatori mancanti
          content:
            application/json:
              example:
                error: "Nome e rewardExp obbligatori"
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

  /missions/available:
    get:
      summary: Ottieni missioni disponibili per l'utente autenticato
      tags: [Missions]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista missioni non ancora attivate dall'utente
          content:
            application/json:
              example:
                - id: "m001"
                  name: "Esplora Parco Sempione"
                  description: "Visita tutte le aree del parco"
                  minLevel: 1
                  rewardExp: 50
                  categories: ["montagna","rilassante"]
                  requiredPlaces:
                    - placeId: "65f1a2c9e4b0a12f34abcd99"
                  requiredCount: 1
        "401":
          description: Non autenticato
          content:
            application/json:
              example:
                error: "Utente non autenticato"
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

  /missions/activate:
    post:
      summary: Attiva una missione per l'utente autenticato
      tags: [Missions]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            example:
              missionId: "m001"
      responses:
        "200":
          description: Missione attivata
          content:
            application/json:
              example:
                success: true
        "400":
          description: Missione già attiva o dati mancanti
          content:
            application/json:
              example:
                error: "Missione già attiva"
        "401":
          description: Non autenticato
          content:
            application/json:
              example:
                error: "Utente non autenticato"
        "404":
          description: Missione non trovata
          content:
            application/json:
              example:
                error: "Missione non trovata"
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

  /missions/{missionId}:
    delete:
      summary: Rimuovi una missione dall'utente autenticato
      tags: [Missions]
      security:
        - bearerAuth: []
      parameters:
        - name: missionId
          in: path
          required: true
          schema:
            type: string
          example: "m001"
      responses:
        "200":
          description: Missione rimossa
          content:
            application/json:
              example:
                success: true
        "400":
          description: missionId mancante
          content:
            application/json:
              example:
                error: "Parametro missionId mancante"
        "401":
          description: Non autenticato
          content:
            application/json:
              example:
                error: "Utente non autenticato"
        "404":
          description: Missione non trovata nell'account utente
          content:
            application/json:
              example:
                error: "Missione non trovata nell'account"
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"


components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    User:
      type: object
      properties:
        id:
          type: string
          example: "65f1a2c9e4b0a12f34abcd12"

        username:
          type: string
          example: "mario.rossi"

        email:
          type: string
          format: email
          example: "mario@example.com"

        name:
          type: string
          example: "Mario"

        surname:
          type: string
          example: "Rossi"

        profileImage:
          type: string
          nullable: true
          example: "https://example.com/avatar.jpg"

        preferences:
          $ref: "#/components/schemas/UserPreferences"

        expert:
          type: boolean
          example: false

        exp:
          type: number
          example: 30

        discoveredPlaces:
          type: array
          items:
            $ref: "#/components/schemas/DiscoveredPlace"

        suggestedPlaces:
          type: array
          items:
            $ref: "#/components/schemas/SuggestedPlace"

        missionsProgresses:
          type: array
          items:
            $ref: "#/components/schemas/MissionProgress"

      required:
        - id
        - username
        - email
        - name
        - surname
        - preferences
        - expert
        - exp
        - discoveredPlaces
        - suggestedPlaces
        - missionsProgresses


    UserPreferences:
      type: object
      properties:
        alsoPaid:
          type: boolean
          example: true

        categories:
          type: array
          items:
            type: string
            enum:
              - montagna
              - lago
              - cultura
              - scienza
              - borgo
              - città
              - gusto
              - indoor
              - outdoor
              - impegnativo
              - rilassante
              - per famiglie
      required:
        - categories


    DiscoveredPlace:
      type: object
      properties:
        placeId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd99"

        date:
          type: string
          format: date-time
          nullable: true
          example: "2025-02-12T10:00:00.000Z"

      required:
        - placeId


    SuggestedPlace:
      type: object
      properties:
        placeId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd88"

        visited:
          type: boolean
          example: false

        date:
          type: string
          format: date-time
          nullable: true
          example: "2025-02-12T10:00:00.000Z"

      required:
        - placeId
        - visited


    MissionProgress:
      type: object
      properties:
        missionId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd77"

        requiredPlacesVisited:
          type: array
          items:
            $ref: "#/components/schemas/RequiredPlaceVisited"

        progress:
          type: number
          example: 2

        completed:
          type: boolean
          example: false

      required:
        - missionId
        - requiredPlacesVisited
        - progress
        - completed


    RequiredPlaceVisited:
      type: object
      properties:
        placeId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd66"

      required:
        - placeId

    Operator:
      type: object
      properties:
        id: { type: string }
        email: { type: string }
        role: { type: string }
        name: { type: string }
        surname: { type: string }

    Place:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        description: { type: string }
        categories:
          type: array
          items: { type: string }
        location:
          type: object
          properties:
            lat: { type: number }
            lon: { type: number }
        images:
          type: array
          items: { type: string }
        isFree: { type: boolean }

    PlaceEdit:
      type: object
      properties:
        id: { type: string }
        placeId: { type: string }
        userId: { type: string }
        proposedChanges:
          type: object
        status:
          type: string
          enum: [pending, approved, rejected]
        operatorId: { type: string }
        operatorComment: { type: string }
        isNewPlace: { type: boolean }
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Mission:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        minLevel:
          type: number
        rewardExp:
          type: number
        categories:
          type: array
          items:
            type: string
        requiredPlaces:
          type: array
          items:
            type: object
            properties:
              placeId:
                type: string
        requiredCount:
          type: number


    ErrorResponse:
      type: object
      properties:
        error:
          type: string
