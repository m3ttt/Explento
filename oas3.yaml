openapi: 3.0.3
info:
  title: API Specification for Explento WebApp
  version: 1.0.0

servers:
  - url: https://explento-backend.onrender.com/
  - url: http://localhost:3000/api/v1

paths:

  ##########################
  # AUTH
  ##########################

  /auth/login:
    post:
      summary: Login utente
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: "Test"
                password:
                  type: string
                  format: password
                  example: "Test"
      responses:
        "200":
          description: Login effettuato, restituisce JWT
          content:
            application/json:
              example:
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Im1hcmlvLnJvc3NpIiwiaWF0IjoxNjg3NjEyMzQ1fQ.DlA8fNn8k_YxQFw1Uo5vNshl5-8Y7kF_8c3zQJfhZyI"
        "400":
          description: Credenziali non valide
          content:
            application/json:
              example:
                error: "Username o password non validi"

  /auth/register:
    post:
      summary: Registrazione utente
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - name
                - surname
                - password
              properties:
                username:
                  type: string
                  example: "luca.bianchi"
                email: 
                  type: string
                  format: email
                  example: "luca.bianchi@example.com"
                name:
                  type: string
                  example: "Luca"
                surname:
                  type: string
                  example: "Bianchi"
                password:
                  type: string
                  example: "StrongPass!2026"
      responses:
        "200":
          description: Registrazione effettuata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Dati non validi o utente già registrato
          content:
            application/json:
              example:
                error: "Email già in uso o campi mancanti"

  ##########################
  # ME
  ##########################

  /me:
    get:
      summary: Ottieni informazioni sull'utente autenticato
      tags: [Me]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Informazioni utente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Non autorizzato
          content:
            application/json:
              example:
                error: "Token mancante o scaduto"

  /me/visit/{id}:
    post:
      summary: Registra la visita di un luogo tramite coordinate GPS
      tags: [Me]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "65f1a2c9e4b0a12f34abcd99"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lan
                - lon
              properties:
                lat:
                  type: number
                  example: 45.4642
                lon: 
                  type: number
                  example: 9.1900
      responses:
        "200":
          description: Visita registrata
          content:
            application/json:
              example:
                success: true
        "400":
          description: Errore di validazione
          content:
            application/json:
              example:
                error: "Coordinate non valide"
        "401":
          description: Non autorizzato
          content:
            application/json:
              example:
                error: "Utente non autenticato"

  /me/preferences:
    post:
      summary: Aggiorna le preferenze dell'utente
      tags: [Me]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserPreferences"
      responses:
        "200":
          description: Preferenze aggiornate
          content:
            application/json:
              example:
                message: "Preferenze aggiornate con successo"
        "400":
          description: Dati mancanti o non validi
          content:
            application/json:
              example:
                error: "Formato JSON non valido o categorie mancanti"

  ##########################
  # USERS
  ##########################

  /users:
    get:
      summary: Ottieni lista utenti
      tags: [Users]
      parameters:
        - name: expert
          in: query
          schema:
            type: boolean
          example: true
      responses:
        "200":
          description: Lista utenti
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    self:
                      type: string
                      example: "/users/luca.bianchi"
                    username:
                      type: string
                      example: "luca.bianchi"
                    exp:
                      type: number
                      example: 10
                    profileImage:
                      type: string
                      example: "https://example.com/avatar_luca.jpg"
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

  /users/{username}:
    get:
      summary: Ottieni utente tramite username
      tags: [Users]
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          example: "luca.bianchi"
      responses:
        "200":
          description: Utente trovato in formato pubblico
          content:
            application/json:
              example:
                self: "/users/luca.bianchi"
                username: "luca.bianchi"
                exp: 10
                profileImage: "https://example.com/avatar_luca.jpg"
        "404":
          description: Utente non trovato
          content:
            application/json:
              example:
                error: "Utente non trovato"

  ##########################
  # OPERATOR
  ##########################

  /operator/login:
    post:
      summary: Login operatore
      tags: [Operator]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  example: "operator@example.com"
                password:
                  type: string
                  format: password
                  example: "OperatorPass!2026"
              required:
                - email
                - password
      responses:
        "200":
          description: Login effettuato, restituisce JWT
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        "400":
          description: Credenziali non valide
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Email o password non valide"

  /operator/me:
    get:
      summary: Ottieni informazioni operatore autenticato
      tags: [Operator]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Operatore trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Operator"
        "401":
          description: Non autorizzato
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Token mancante o scaduto"

  /operator/place_edit_requests:
    get:
      summary: Ottieni richieste di modifica luoghi
      tags: [Operator]
      security:
        - bearerAuth: []
      parameters:
        - name: placeId
          in: query
          schema:
            type: string
          example: "65f1a2c9e4b0a12f34abcd99"
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, approved, rejected]
          example: "pending"
        - name: isNewPlace
          in: query
          schema:
            type: boolean
          example: true
      responses:
        "200":
          description: Lista richieste
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PlaceEditRequest"
        "400":
          description: Parametri non validi
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Parametro status non valido"

  /operator/place_edit_requests/{id}:
    get:
      summary: Ottieni richiesta di modifica specifica
      tags: [Operator]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "req123"
      responses:
        "200":
          description: Richiesta trovata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlaceEditRequest"
        "404":
          description: Richiesta non trovata
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Richiesta non trovata"
    patch:
      summary: Aggiorna stato richiesta
      tags: [Operator]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "req123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [pending, approved, rejected]
                  example: "approved"
                operatorComment:
                  type: string
                  example: "Controllato e approvato"
              required:
                - status
      responses:
        "200":
          description: Stato aggiornato
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Richiesta aggiornata"
                  status:
                    type: string
                    enum: [pending, approved, rejected]
                    example: "approved"
        "400":
          description: Errore richiesta non valida
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Stato non valido o richiesta già processata"
        "404":
          description: Richiesta non trovata
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Richiesta non trovata"

  ##########################
  # PLACES
  ##########################

  /places:
    get:
      summary: Ottieni lista luoghi consigliati all'utente autenticato
      tags: [Place]
      security:
        - bearerAuth: []
      parameters:
        - name: lat
          in: query
          schema:
            type: number
          description: Latitudine dell’utente per filtro distanza
        - name: lon
          in: query
          schema:
            type: number
          description: Longitudine dell’utente per filtro distanza
        - name: radius
          in: query
          schema:
            type: number
            description: Raggio in metri per cercare luoghi vicini
      responses:
        "200":
          description: Lista luoghi filtrati e ordinati per distanza
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Place"
        "500":
          description: Errore del server
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Errore del server"

    post:
      summary: Crea richiesta di nuovo luogo
      tags: [Place]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                categories:
                  type: array
                  items:
                    type: string
                location:
                  type: object
                  properties:
                    lat:
                      type: number
                    lon:
                      type: number
                  required:
                    - lat
                    - lon
                images:
                  type: array
                  items:
                    type: string
                    format: base64
                isFree:
                  type: boolean
              required:
                - name
                - categories
                - location
                - isFree
      responses:
        "201":
          description: Richiesta creata con successo
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Richiesta di nuovo luogo inviata e in attesa di approvazione"
                  request:
                    $ref: "#/components/schemas/PlaceEditRequest"
        "400":
          description: Dati non validi
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        "409":
          description: Luogo già esistente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Questo luogo esiste già nell'applicazione"
                  placeId:
                    type: string

  /places/{id}:
    get:
      summary: Ottieni luogo per ID
      tags: [Place]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Luogo trovato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Place"
        "400":
          description: Luogo non trovato
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Luogo non trovato"

    put:
      summary: Crea richiesta di aggiornamento luogo esistente
      tags: [Place]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                categories:
                  type: array
                  items:
                    type: string
                location:
                  type: object
                  properties:
                    lat:
                      type: number
                    lon:
                      type: number
                  required:
                    - lat
                    - lon
                images:
                  type: array
                  items:
                    type: string
                    format: base64
                isFree:
                  type: boolean
              required:
                - name
                - categories
                - location
                - isFree
      responses:
        "201":
          description: Richiesta di modifica creata con successo
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Richiesta di modifica inviata e in attesa di approvazione"
                  request:
                    $ref: "#/components/schemas/PlaceEditRequest"
        "400":
          description: Dati non validi o luogo non trovato
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  ##########################
  # HEATMAP
  ##########################

  /heatmap/missions:
    get:
      summary: Heatmap delle missioni completate per luogo
      tags: [Heatmap]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista luoghi con conteggio missioni completate
          content:
            application/json:
              example:
                - placeId: "65f1a2c9e4b0a12f34abcd99"
                  name: "Parco Sempione"
                  completedMissions: 5
                  location:
                    lat: 45.4700
                    lon: 9.1800
                - placeId: "65f1a2c9e4b0a12f34abcd98"
                  name: "Museo della Scienza"
                  completedMissions: 2
                  location:
                    lat: 45.4660
                    lon: 9.1930
        "500":
          description: Errore server
          content:
            application/json:
              example:
                error: "Errore interno del server"

  ##########################
  # MISSIONS
  ##########################

  /missions:
    get:
      summary: Ottieni tutte le missioni
      tags: [Missions]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista completa missioni
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Mission"
        "500":
          description: Errore server
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Errore interno del server"

  /missions/available:
    get:
      summary: Ottieni missioni disponibili per l'utente autenticato
      tags: [Missions]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista missioni non ancora attivate dall'utente
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Mission"
        "401":
          description: Non autenticato
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Utente non autenticato"
        "500":
          description: Errore server
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Errore interno del server"

  /missions/activate:
    post:
      summary: Attiva una missione per l'utente autenticato
      tags: [Missions]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                missionId:
                  type: string
                  example: "m001"
      responses:
        "200":
          description: Missione attivata
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        "400":
          description: Missione già attiva o dati mancanti
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Missione già attiva"
        "401":
          description: Non autenticato
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Utente non autenticato"
        "404":
          description: Missione non trovata
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Missione non trovata"
        "500":
          description: Errore server
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Errore interno del server"

  /missions/{missionId}:
    delete:
      summary: Rimuovi una missione dall'utente autenticato
      tags: [Missions]
      security:
        - bearerAuth: []
      parameters:
        - name: missionId
          in: path
          required: true
          schema:
            type: string
          example: "m001"
      responses:
        "200":
          description: Missione rimossa
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        "400":
          description: missionId mancante
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Parametro missionId mancante"
        "401":
          description: Non autenticato
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Utente non autenticato"
        "404":
          description: Missione non trovata nell'account utente
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Missione non trovata nell'account"
        "500":
          description: Errore server
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Errore interno del server"

components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    Operator:
      type: object
      properties:
        id:
          type: string
          example: "65f1a2c9e4b0a12f34abcd01"
        email:
          type: string
          format: email
          example: "operator@example.com"
        role:
          type: string
          example: "operator"
        name:
          type: string
          example: "Giulia"
        surname:
          type: string
          example: "Verdi"
      required:
        - id
        - email
        - role

    Place:
      type: object
      properties:
        id:
          type: string
          example: "65f1a2c9e4b0a12f34abcd99"
        name:
          type: string
          example: "Parco Sempione"
        description:
          type: string
          example: "Grande parco pubblico nel centro città"
        categories:
          type: array
          items:
            type: string
            enum:
              - montagna
              - lago
              - cultura
              - scienza
              - borgo
              - città
              - gusto
              - indoor
              - outdoor
              - impegnativo
              - rilassante
              - per famiglie
        location:
          type: object
          properties:
            lat:
              type: number
              example: 45.4700
            lon:
              type: number
              example: 9.1800
          required:
            - lat
            - lon
        images:
          type: array
          items:
            type: string
            format: uri
        isFree:
          type: boolean
          example: true
      required:
        - id
        - name
        - categories
        - location
        - isFree

    PlaceEditRequest:
      type: object
      properties:
        id:
          type: string
          example: "req123"
        placeId:
          type: string
          nullable: true
          example: "65f1a2c9e4b0a12f34abcd99"
        userId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd12"
        proposedChanges:
          type: object
          description: Campi modificati o proposti dall’utente
          example:
            name: "Nuovo Parco"
            description: "Parco aggiornato con nuove aree"
        isNewPlace:
          type: boolean
          example: false
        status:
          type: string
          enum:
            - pending
            - approved
            - rejected
          example: "pending"
        operatorId:
          type: string
          nullable: true
          example: "65f1a2c9e4b0a12f34abcd50"
        operatorComment:
          type: string
          nullable: true
          example: "Controllato e approvato"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - userId
        - proposedChanges
        - status
        - isNewPlace
        - createdAt
        - updatedAt

    Mission:
      type: object
      properties:
        id:
          type: string
          example: "m001"
        name:
          type: string
          example: "Esplora Parco"
        description:
          type: string
          example: "Visita tutte le aree del parco"
        minLevel:
          type: number
          example: 1
        rewardExp:
          type: number
          example: 50
        categories:
          type: array
          items:
            type: string
        requiredPlaces:
          type: array
          items:
            type: object
            properties:
              placeId:
                type: string
                example: "65f1a2c9e4b0a12f34abcd99"
            required:
              - placeId
        requiredCount:
          type: number
          example: 1
      required:
        - id
        - name
        - rewardExp
        - categories
    User:
      type: object
      properties:
        id:
          type: string
          example: "65f1a2c9e4b0a12f34abcd12"
        username:
          type: string
          example: "mario.rossi"
        email:
          type: string
          format: email
          example: "mario@example.com"
        name:
          type: string
          example: "Mario"
        surname:
          type: string
          example: "Rossi"
        profileImage:
          type: string
          nullable: true
          example: "https://example.com/avatar.jpg"
        preferences:
          $ref: "#/components/schemas/UserPreferences"
        expert:
          type: boolean
          example: false
        exp:
          type: number
          example: 30
        discoveredPlaces:
          type: array
          items:
            $ref: "#/components/schemas/DiscoveredPlace"
        suggestedPlaces:
          type: array
          items:
            $ref: "#/components/schemas/SuggestedPlace"
        missionsProgresses:
          type: array
          items:
            $ref: "#/components/schemas/MissionProgress"
      required:
        - id
        - username
        - email
        - name
        - surname
        - preferences
        - expert
        - exp
        - discoveredPlaces
        - suggestedPlaces
        - missionsProgresses

    UserPreferences:
      type: object
      properties:
        alsoPaid:
          type: boolean
          example: true
        categories:
          type: array
          items:
            type: string
            enum:
              - montagna
              - lago
              - cultura
              - scienza
              - borgo
              - città
              - gusto
              - indoor
              - outdoor
              - impegnativo
              - rilassante
              - per famiglie
      required:
        - categories

    DiscoveredPlace:
      type: object
      properties:
        placeId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd99"
        date:
          type: string
          format: date-time
          nullable: true
          example: "2025-02-12T10:00:00.000Z"
      required:
        - placeId

    SuggestedPlace:
      type: object
      properties:
        placeId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd88"
        visited:
          type: boolean
          example: false
        date:
          type: string
          format: date-time
          nullable: true
          example: "2025-02-12T10:00:00.000Z"
      required:
        - placeId
        - visited

    MissionProgress:
      type: object
      properties:
        missionId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd77"
        requiredPlacesVisited:
          type: array
          items:
            $ref: "#/components/schemas/RequiredPlaceVisited"
        progress:
          type: number
          example: 2
        completed:
          type: boolean
          example: false
      required:
        - missionId
        - requiredPlacesVisited
        - progress
        - completed

    RequiredPlaceVisited:
      type: object
      properties:
        placeId:
          type: string
          example: "65f1a2c9e4b0a12f34abcd66"
      required:
        - placeId
